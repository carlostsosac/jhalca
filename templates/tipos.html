{% extends "base.html" %}
{% block content %}

<ul class="nav nav-tabs" id="tabs-{{ form_name }}" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#tab-form" type="button">Formulario</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="buscar-tab" data-bs-toggle="tab" data-bs-target="#tab-buscar" type="button">Buscar / Editar</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#tab-reportes" type="button">Reportes</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="tab-form">
    <form method="post" id="tipo-form">
      <input type="hidden" name="id" id="tipo-id">
      <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input class="form-control" name="nombre" id="tipo-nombre" required placeholder="Ej: Inventario, Servicios, VIP, etc.">
      </div>
      <div class="mb-3">
        <label class="form-label">Clase</label>
        <select class="form-select" name="clase" id="tipo-clase" required>
          <option value="">Seleccione una clase</option>
          <option value="mercancia">Mercancía</option>
          <option value="cliente">Cliente</option>
          <option value="proveedor">Proveedor</option>
          <option value="comprobante">Comprobante</option>
          <option value="general">Gasto</option>
          <option value="ajuste">Ajuste</option>
        </select>
      </div>
      <button class="btn btn-success">Guardar</button>
      <button type="button" class="btn btn-outline-secondary ms-2" id="limpiar-form">Nuevo</button>
    </form>
  </div>

  <div class="tab-pane fade" id="tab-buscar">
    <div class="row">
      <div class="col-md-6">
        <div class="input-group mb-3">
          <input id="buscar-input" class="form-control" placeholder="Escriba para buscar...">
          <button id="buscar-btn" class="btn btn-primary">Buscar</button>
        </div>
      </div>
      <div class="col-md-6">
        <select id="filtro-clase" class="form-select">
          <option value="">Todas las clases</option>
          <option value="mercancia">Mercancía</option>
          <option value="cliente">Cliente</option>
          <option value="proveedor">Proveedor</option>
          <option value="comprobante">Comprobante</option>
          <option value="gasto">Gasto</option>
          <option value="ajuste">Ajuste</option>
        </select>
      </div>
    </div>
    <div id="buscar-resultados">
      <!-- resultados via fetch / ajax -->
    </div>
  </div>

  <div class="tab-pane fade" id="tab-reportes">
    <p>Reportes relacionados a {{ page_title }}:</p>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-primary">Reporte PDF</button>
      <button class="btn btn-outline-secondary">Exportar Excel</button>
      <button class="btn btn-outline-info">Listado por Clase</button>
    </div>
  </div>
</div>

<script>
const buscarBtn = document.getElementById('buscar-btn');
const buscarInput = document.getElementById('buscar-input');
const filtroClase = document.getElementById('filtro-clase');
const resultadosDiv = document.getElementById('buscar-resultados');

async function buscarTipos(){
  const q = (buscarInput.value || '').trim();
  const clase = filtroClase.value || '';
  resultadosDiv.innerHTML = '';
  
  try {
    let url = '/api/tipos?';
    if(q) url += `q=${encodeURIComponent(q)}&`;
    if(clase) url += `clase=${encodeURIComponent(clase)}&`;
    
    const res = await fetch(url);
    if(!res.ok) throw new Error('Error al buscar');
    const data = await res.json();
    
    if(data.length === 0){
      resultadosDiv.innerHTML = '<div class="alert alert-info">No hay resultados.</div>';
      return;
    }
    
    let html = '<div class="list-group">';
    for(const t of data){
      html += `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div><strong>${t.nombre || ''}</strong></div>
          <div class="small text-muted">Clase: ${t.clase || ''}</div>
        </div>
        <button class="btn btn-sm btn-primary" data-action="editar" data-id="${t.id}">Editar</button>
      </div>`;
    }
    html += '</div>';
    resultadosDiv.innerHTML = html;
  } catch(err){
    resultadosDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
  }
}

buscarBtn?.addEventListener('click', function(e){
  e.preventDefault();
  buscarTipos();
});

filtroClase?.addEventListener('change', function(){
  if(buscarInput.value.trim() || filtroClase.value) {
    buscarTipos();
  }
});

resultadosDiv?.addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-action="editar"]');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  try {
    const res = await fetch(`/api/tipos/${id}`);
    if(!res.ok) throw new Error('No se pudo cargar el tipo');
    const t = await res.json();
    document.getElementById('tipo-id').value = t.id || '';
    document.getElementById('tipo-nombre').value = t.nombre || '';
    document.getElementById('tipo-clase').value = t.clase || '';
    
    const tabTrigger = document.getElementById('form-tab');
    if(tabTrigger && window.bootstrap){
      const tab = new bootstrap.Tab(tabTrigger);
      tab.show();
    } else {
      document.getElementById('tab-form')?.scrollIntoView({behavior:'smooth'});
    }
  } catch(err){
    alert('Error al cargar tipo: ' + err.message);
  }
});

// Botón "Nuevo" para limpiar y volver a modo creación
const limpiar = document.getElementById('limpiar-form');
limpiar?.addEventListener('click', function(){
  document.getElementById('tipo-id').value = '';
  document.getElementById('tipo-form').reset();
});
</script>
{% endblock %}