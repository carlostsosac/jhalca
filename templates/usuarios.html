{% extends "base.html" %}
{% block content %}
<h3>{{ page_title }}</h3>

<ul class="nav nav-tabs" id="tabs-{{ form_name }}" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#tab-form" type="button">Formulario</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="buscar-tab" data-bs-toggle="tab" data-bs-target="#tab-buscar" type="button">Buscar / Editar</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#tab-reportes" type="button">Reportes</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="tab-form">
    <form method="post" id="usuario-form">
      <input type="hidden" name="id" id="usuario-id">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Usuario</label>
          <input class="form-control" name="username" id="usuario-username" required placeholder="Ej: jdoe">
        </div>
        <div class="col-md-6">
          <label class="form-label">Nombre completo</label>
          <input class="form-control" name="fullname" id="usuario-fullname" placeholder="Ej: Juan Pérez">
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Foto (URL)</label>
          <input class="form-control" name="photo_url" id="usuario-photo_url" placeholder="https://...">
        </div>
        <div class="col-md-6">
          <label class="form-label">Clave</label>
          <input type="password" class="form-control" name="password" id="usuario-password" placeholder="Opcional para actualizar">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-outline-secondary ms-2" id="limpiar-form">Nuevo</button>
      </div>
    </form>
  </div>

  <div class="tab-pane fade" id="tab-buscar">
    <div class="row">
      <div class="col-md-6">
        <div class="input-group mb-3">
          <input id="buscar-input" class="form-control" placeholder="Escriba para buscar (usuario o nombre)...">
          <button id="buscar-btn" class="btn btn-primary">Buscar</button>
        </div>
      </div>
    </div>
    <div id="buscar-resultados"></div>
  </div>

  <div class="tab-pane fade" id="tab-reportes">
    <p>Reportes relacionados a {{ page_title }}:</p>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-primary" disabled>Listado PDF (próximamente)</button>
      <button class="btn btn-outline-secondary" disabled>Exportar Excel (próximamente)</button>
    </div>
  </div>
</div>

<script>
const buscarBtn = document.getElementById('buscar-btn');
const buscarInput = document.getElementById('buscar-input');
const resultadosDiv = document.getElementById('buscar-resultados');

async function buscarUsuarios(){
  const q = (buscarInput?.value || '').trim();
  resultadosDiv.innerHTML = '';
  try {
    let url = '/api/usuarios?';
    if(q) url += `q=${encodeURIComponent(q)}&`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Error al buscar');
    const data = await res.json();
    if(data.length === 0){
      resultadosDiv.innerHTML = '<div class="alert alert-info">No hay resultados.</div>';
      return;
    }
    let html = '<div class="list-group">';
    for(const u of data){
      html += `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div><strong>${u.username || ''}</strong></div>
          <div class="small text-muted">Nombre: ${u.fullname || ''}</div>
        </div>
        <button class="btn btn-sm btn-primary" data-action="editar" data-id="${u.id}">Editar</button>
      </div>`;
    }
    html += '</div>';
    resultadosDiv.innerHTML = html;
  } catch(err){
    resultadosDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
  }
}

buscarBtn?.addEventListener('click', function(e){
  e.preventDefault();
  buscarUsuarios();
});

buscarInput?.addEventListener('keydown', function(e){
  if(e.key === 'Enter'){
    e.preventDefault();
    buscarUsuarios();
  }
});

resultadosDiv?.addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-action="editar"]');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  try {
    const res = await fetch(`/api/usuarios/${id}`);
    if(!res.ok) throw new Error('No se pudo cargar el usuario');
    const u = await res.json();
    document.getElementById('usuario-id').value = u.id || '';
    document.getElementById('usuario-username').value = u.username || '';
    document.getElementById('usuario-fullname').value = u.fullname || '';
    document.getElementById('usuario-photo_url').value = u.photo_url || '';
    document.getElementById('usuario-password').value = '';
    const tabTrigger = document.getElementById('form-tab');
    if(tabTrigger && window.bootstrap){
      const tab = new bootstrap.Tab(tabTrigger);
      tab.show();
    } else {
      document.getElementById('tab-form')?.scrollIntoView({behavior:'smooth'});
    }
  } catch(err){
    alert('Error al cargar usuario: ' + err.message);
  }
});

const limpiar = document.getElementById('limpiar-form');
limpiar?.addEventListener('click', function(){
  document.getElementById('usuario-id').value = '';
  document.getElementById('usuario-form').reset();
});
</script>
{% endblock %}